stages:
  - build
  - test
  - deploy

variables:
  DOCKER_IMAGE: "riper3d/docere_proj"
  DOCKER_REGISTRY: "docker.io"

before_script:
  - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $DOCKER_REGISTRY

build:
  stage: build
  script:
    - echo "ðŸ”¨ Building image for $CI_COMMIT_BRANCH"
    - docker build --network="host" -t $DOCKER_IMAGE:$CI_COMMIT_REF_NAME .
    - docker tag $DOCKER_IMAGE:$CI_COMMIT_REF_NAME $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_IMAGE:$CI_COMMIT_REF_NAME
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "dev"'

test:
  stage: test
  script:
    - echo "âœ… Test stage passed"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "dev"'

deploy_test:
  stage: deploy
  script:
    - echo "ðŸš€ Deploying to TEST server"
    - ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SSH_USER_TEST@$SSH_HOST_TEST
  environment:
    name: test
    url: https://test.docere.online
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'

deploy_prod:
  stage: deploy
  script:
    - echo "ðŸš€ Deploying to PROD server"
    - ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SSH_USER_PROD@$SSH_HOST_PROD
  environment:
    name: production
    url: https://docere.online
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
